{
	"info": {
		"_postman_id": "488e305d-aa15-4345-8ba0-723795032dcf",
		"name": "event-framework-tests",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "Transfer_Prepare_Fulfil_Commit",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "9d58aca2-4bdc-4c4b-b12b-b70c76f3c36d",
						"exec": [
							"var uuid = require('uuid');",
							"var generatedUUID = uuid.v4();",
							"",
							"pm.environment.set('transfer_ID', generatedUUID);",
							"",
							"pm.variables.set('transferDate', (new Date()).toUTCString());",
							"",
							"pm.environment.set(\"transferExpiration\",new Date(new Date().getTime() + 600000));",
							"",
							""
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"id": "b1bac429-8eba-409d-accc-49fe7038a3ef",
						"exec": [
							"pm.test(\"Status code is 202\", function () {",
							"    pm.response.to.have.status(202);",
							"});",
							"",
							"//Check the request that Switch forwards to payeefsp",
							"setTimeout(function () {",
							"  pm.sendRequest(pm.environment.get(\"HOST_SIMULATOR\")+\"/payeefsp/requests/\"+pm.environment.get(\"transfer_ID\"), function (err, response) {",
							"          if(response.responseSize !== 0) {",
							"              ",
							"              //Check the Headers",
							"              var headers = response.json().headers;",
							"              ",
							"                pm.test(\"payeefsp fspiop-source is payerfsp\", function () {",
							"                    pm.expect(headers['fspiop-source']).to.eql('payerfsp');",
							"                });",
							"                ",
							"                pm.test(\"payeefsp fspiop-destination is payeefsp\", function () {",
							"                    pm.expect(headers['fspiop-destination']).to.eql('payeefsp');",
							"                });",
							"                ",
							"                pm.test(\"payeefsp content-typeis same as sent in the request\", function () {",
							"                    pm.expect(headers['content-type']).to.eql('application/vnd.interoperability.transfers+json;version=1.0');",
							"                });",
							"                ",
							"                pm.test(\"payeefsp accept is same as sent in the request\", function () {",
							"                    pm.expect(headers['accept']).to.eql('application/vnd.interoperability.transfers+json;version=1');",
							"                });",
							"                ",
							"                pm.test(\"payeefsp fspiop-signature is same as sent in the request\", function () {",
							"                    pm.expect(headers['fspiop-signature']).to.eql(pm.environment.get(\"fspiop-signature\"));",
							"                });",
							"                ",
							"                pm.test(\"payeefsp fspiop-http-method is POST\", function () {",
							"                    pm.expect(headers['fspiop-http-method']).to.eql('POST');",
							"                });",
							"                ",
							"                pm.test(\"payeefsp fspiop-uri is /transfers\", function () {",
							"                    pm.expect(headers['fspiop-uri']).to.eql('/transfers');",
							"                });",
							"                ",
							"                ",
							"                //Check the data",
							"                var jsonData = response.json().data;",
							"                pm.test(\"payeefsp data should have the same transferId as request\", function () {",
							"                   pm.expect(jsonData.transferId).to.eql(pm.environment.get(\"transfer_ID\"));",
							"                });",
							"                pm.test(\"payeefsp data should have the same payerfspId as request\", function () {",
							"                   pm.expect(jsonData.payerFsp).to.eql(pm.environment.get(\"payerfsp\"));",
							"                });",
							"                pm.test(\"payeefsp data should have the same payeefspId as request\", function () {",
							"                   pm.expect(jsonData.payeeFsp).to.eql(pm.environment.get(\"payeefsp\"));",
							"                });",
							"                pm.test(\"payeefsp data should have the same amount as request\", function () {",
							"                   pm.expect(jsonData.amount.amount).to.eql('1');",
							"                });",
							"                pm.test(\"payeefsp data should have the same currency as request\", function () {",
							"                   pm.expect(jsonData.amount.currency).to.eql(pm.environment.get(\"currency\"));",
							"                });",
							"                pm.test(\"payeefsp data should have the same expiration as request\", function () {",
							"                   pm.expect(jsonData.expiration).to.eql(pm.environment.get(\"transferExpiration\"));",
							"                });",
							"                pm.test(\"payeefsp data should have the same ilpPacket as request\", function () {",
							"                   pm.expect(jsonData.ilpPacket).to.eql(pm.environment.get(\"ilpPacket\"));",
							"                });",
							"                pm.test(\"payeefsp data should have the same condition as request\", function () {",
							"                   pm.expect(jsonData.condition).to.eql(pm.environment.get(\"condition\"));",
							"                });",
							"                ",
							"          } else {",
							"              pm.test(\"Transfer FAILED\", function () {",
							"                throw new Error('Did not receive response');",
							"              });",
							"",
							"          }",
							"   });",
							"}, 1100)",
							"",
							"//Check the callback response that Switch forwards to payerfsp",
							"setTimeout(function () {",
							"  pm.sendRequest(pm.environment.get(\"HOST_SIMULATOR\")+\"/payerfsp/callbacks/\"+pm.environment.get(\"transfer_ID\"), function (err, response) {",
							"          if(response.responseSize !== 0) {",
							"            //Checking headers",
							"            var headers = response.json().headers;",
							"            pm.test(\"payerfsp fspiop-source is payeefsp\", function () {",
							"                pm.expect(headers['fspiop-source']).to.eql('payeefsp');",
							"            });",
							"            ",
							"            pm.test(\"payerfsp fspiop-destination is payerfsp\", function () {",
							"                pm.expect(headers['fspiop-destination']).to.eql('payerfsp');",
							"            });",
							"            ",
							"            pm.test(\"payerfsp content-type should be application/vnd.interoperability.transfers+json;version=1.0\", function () {",
							"                pm.expect(headers['content-type']).to.eql('application/vnd.interoperability.transfers+json;version=1.0');",
							"            });",
							"            ",
							"            pm.test(\"payerfsp accept is empty\", function () {",
							"                pm.expect(headers['accept']).to.eql(undefined);",
							"            });",
							"           ",
							"            ",
							"            pm.test(\"payerfsp fspiop-uri includes transfers\", function () {",
							"                pm.expect(headers['fspiop-uri']).to.include('/transfers');",
							"            });",
							"            ",
							"            pm.test(\"payerfsp fspiop-http-method is PUT\", function () {",
							"                pm.expect(headers['fspiop-http-method']).to.eql('PUT');",
							"            });",
							"            ",
							"            var jsonData = response.json().data;",
							"            pm.test(\"Response data does not have transferId\", function () {",
							"               pm.expect(jsonData.transferId).to.eql(undefined);",
							"            });",
							"            pm.test(\"Response status is COMMITTED\", function () {",
							"                pm.expect(jsonData.transferState).to.eql('COMMITTED');",
							"            });",
							"          } else {",
							"              pm.test(\"Transfer FAILED\", function () {",
							"                throw new Error('Did not receive response');",
							"              });",
							"",
							"          }",
							"   });",
							"}, 1300)",
							"",
							"const { payeeFsp, payerFsp, transferId } = JSON.parse(request.data)",
							"const destination = request.headers['fspiop-destination']",
							"const source = request.headers['fspiop-source']",
							"",
							"const expectations = {",
							"    mojaloop: new Map([",
							"    ['cl_transfer_prepare',",
							"        [{ action: 'egress', type: 'audit',transactionAction: 'prepare', transactionType: 'transfer'},",
							"        { action: 'start', type: 'audit',transactionAction: 'prepare', transactionType: 'transfer' },",
							"        { action: 'span', type: 'trace' ,transactionAction: 'prepare', transactionType: 'transfer'}]",
							"    ],",
							"    ['ml_transfer_prepare',",
							"        [{ action: 'start', type: 'audit',transactionAction: 'prepare', transactionType: 'transfer' },",
							"        { action: 'span', type: 'trace' ,transactionAction: 'prepare', transactionType: 'transfer'}]",
							"    ],",
							"    ['cl_transfer_position',",
							"        [{ action: 'egress', type: 'audit',transactionAction: 'prepare', transactionType: 'transfer'  },",
							"        { action: 'start', type: 'audit',transactionAction: 'prepare', transactionType: 'transfer'  },",
							"        { action: 'span', type: 'trace',transactionAction: 'prepare', transactionType: 'transfer'  },",
							"        { action: 'start', type: 'audit',transactionAction: 'fulfil', transactionType: 'transfer'  },",
							"        { action: 'egress', type: 'audit',transactionAction: 'fulfil', transactionType: 'transfer'  },",
							"        { action: 'span', type: 'trace',transactionAction: 'fulfil', transactionType: 'transfer'  }]",
							"    ],",
							"    ['ml_notification_event',",
							"        [{ action: 'egress', type: 'audit',transactionAction: 'prepare', transactionType: 'transfer'  } ,",
							"        { action: 'start', type: 'audit',transactionAction: 'prepare', transactionType: 'transfer'  } ,",
							"        { action: 'span', type: 'trace' ,transactionAction: 'prepare', transactionType: 'transfer'  },",
							"        { action: 'egress', type: 'audit',transactionAction: 'fulfil', transactionType: 'transfer'  } ,",
							"        { action: 'start', type: 'audit' ,transactionAction: 'fulfil', transactionType: 'transfer'  },",
							"        { action: 'span', type: 'trace' ,transactionAction: 'fulfil', transactionType: 'transfer'  }]",
							"    ],",
							"    ['cl_transfer_fulfil',",
							"        [{ action: 'egress', type: 'audit' ,transactionAction: 'fulfil', transactionType: 'transfer'  },",
							"        { action: 'start', type: 'audit',transactionAction: 'fulfil', transactionType: 'transfer'   },",
							"        { action: 'span', type: 'trace' ,transactionAction: 'fulfil', transactionType: 'transfer'  }]",
							"    ],",
							"    ['ml_transfer_fulfil',",
							"        [{ action: 'start', type: 'audit' ,transactionAction: 'fulfil', transactionType: 'transfer' },",
							"        { action: 'span', type: 'trace' ,transactionAction: 'fulfil', transactionType: 'transfer' },",
							"        { action: 'debug', type: 'log' ,transactionAction: 'fulfil', transactionType: 'transfer' }]]",
							"    ]),",
							"    apm: new Map([",
							"        ['cl_transfer_prepare', [{",
							"            labels: {",
							"                transactionType: 'transfer',",
							"                transactionAction: 'prepare',",
							"                transactionId: transferId,",
							"                source,",
							"                destination,",
							"                payerFsp,",
							"                payeeFsp",
							"            }",
							"        }]],",
							"        ['cl_transfer_position', [{",
							"            labels: {",
							"                transactionType: 'transfer',",
							"                transactionAction: 'prepare',",
							"                transactionId: transferId,",
							"                source,",
							"                destination,",
							"                payerFsp,",
							"                payeeFsp",
							"            }",
							"        },{",
							"            labels: {",
							"                transactionType: 'transfer',",
							"                transactionAction: 'fulfil',",
							"                transactionId: transferId,",
							"                source:destination,",
							"                destination:source",
							"            }",
							"        }]",
							"        ],",
							"        ['ml_notification_event', [{",
							"            labels: {",
							"                transactionType: 'transfer',",
							"                transactionAction: 'prepare', ",
							"                transactionId: transferId,",
							"                source,",
							"                destination,",
							"                payerFsp,",
							"                payeeFsp",
							"            }",
							"        },{",
							"            labels: {",
							"                transactionType: 'transfer',",
							"                transactionAction: 'fulfil', ",
							"                transactionId: transferId,",
							"                source:destination,",
							"                destination:source",
							"            }}]",
							"        ],",
							"        ['cl_transfer_fulfil', [{",
							"            labels: {",
							"                transactionType: 'transfer',",
							"                transactionAction: 'fulfil', ",
							"                transactionId: transferId,",
							"                source:destination,",
							"                destination:source",
							"            }",
							"        }]],",
							"",
							"        ['ml_transfer_fulfil', [{",
							"            labels: {",
							"                transactionType: 'transfer',",
							"                transactionAction: 'fulfil',",
							"                transactionId: transferId,",
							"                source:destination,",
							"                destination:source",
							"            }",
							"        }]],",
							"        ['ml_transfer_prepare', [{",
							"            labels: {",
							"                transactionType: 'transfer',",
							"                transactionAction: 'prepare', ",
							"                transactionId: transferId,",
							"                source,",
							"                destination,",
							"                payerFsp,",
							"                payeeFsp",
							"            }",
							"        }]]",
							"    ])",
							"}",
							"",
							" setTimeout(() => CommonTests.EFKTest(pm, 'http://dev1-elasticsearch.mojaloop.live/_all/_search?pretty', transferId, pm.response, expectations), pm.variables.get('TIMEOUT_EFK_TESTS'))",
							"",
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Accept",
						"value": "application/vnd.interoperability.transfers+json;version=1"
					},
					{
						"key": "Content-Type",
						"value": "application/vnd.interoperability.transfers+json;version=1.0"
					},
					{
						"key": "Date",
						"value": "{{transferDate}}"
					},
					{
						"key": "FSPIOP-Source",
						"value": "{{payerfsp}}"
					},
					{
						"key": "FSPIOP-Destination",
						"value": "{{payeefsp}}"
					},
					{
						"key": "FSPIOP-Signature",
						"value": "{{fspiop-signature}}",
						"type": "text"
					},
					{
						"key": "FSPIOP-URI",
						"value": "/transfers",
						"type": "text"
					},
					{
						"key": "FSPIOP-HTTP-Method",
						"value": "POST",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n  \"transferId\": \"{{transfer_ID}}\",\n  \"payerFsp\": \"{{payerfsp}}\",\n  \"payeeFsp\": \"{{payeefsp}}\",\n  \"amount\": {\n    \"amount\": \"1\",\n    \"currency\": \"{{currency}}\"\n  },\n  \"expiration\": \"{{transferExpiration}}\",\n  \"ilpPacket\": \"{{ilpPacket}}\",\n  \"condition\": \"{{condition}}\"\n}\n"
				},
				"url": {
					"raw": "{{HOST_SWITCH_TRANSFERS}}{{BASE_PATH_SWITCH_TRANSFERS}}/transfers",
					"host": [
						"{{HOST_SWITCH_TRANSFERS}}{{BASE_PATH_SWITCH_TRANSFERS}}"
					],
					"path": [
						"transfers"
					]
				}
			},
			"response": []
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"id": "153c0e6e-2fce-42ac-98c1-efa8542169dd",
				"type": "text/javascript",
				"exec": [
					"CommonTests = {",
					"    EFKTest: function (pm, url, transferId, response, expectations) {",
					"            let results = {",
					"                mojaloop: new Map(),",
					"                apm: new Map(),",
					"                fail: false",
					"            }",
					"            pm.sendRequest({",
					"                url,",
					"                method: 'POST',",
					"                header: 'content-type:application/json',",
					"                body: {",
					"                    mode: 'raw',",
					"                    raw: JSON.stringify({",
					"                        \"query\": {",
					"                            \"query_string\": {",
					"                                \"query\": `(metadata.trace.tags.transactionId:\\\"${transferId}\\\" OR labels.transactionId:\\\"${transferId}\\\")`",
					"                            }",
					"                        },",
					"                        \"size\": 60",
					"                    })",
					"                }",
					"            }, function (err, res) {",
					"                if (err) console.log('Error ', err)",
					"                const body = res.json()",
					"    ",
					"                pm.test(\"response to have status code 202\", function () {",
					"                    pm.expect(response).to.have.status(202)",
					"                })",
					"    ",
					"                pm.test(\"result to have entries matching the response hits entries\", function () {",
					"                    pm.expect(body.hits.hits.length).to.eql(body.hits.total.value)",
					"                })",
					"                body.hits.hits.forEach(entry => {",
					"                    if (entry._index.match(/mojaloop*/)) {",
					"                        let { type, action } = entry._source.metadata.event",
					"                        let { transactionType, transactionAction } = entry._source.metadata.trace.tags",
					"                        if (results.mojaloop.has(`${entry._source.metadata.trace.service}`)) {",
					"                            let record = results.mojaloop.get(`${entry._source.metadata.trace.service}`)",
					"                            record.push({ transactionType, transactionAction, type, action })",
					"                            results.mojaloop.set(`${entry._source.metadata.trace.service}`, record)",
					"                        } else {",
					"                            results.mojaloop.set(`${entry._source.metadata.trace.service}`, [{ transactionType, transactionAction, type, action }])",
					"                        }",
					"                    } else if (entry._index.match(/apm*/)) {",
					"                        let { labels } = entry._source",
					"                        if (results.apm.has(`${entry._source.transaction.name}`)){",
					"                            let record = results.apm.get(`${entry._source.transaction.name}`)",
					"                            record.push({labels})",
					"                            results.apm.set(`${entry._source.transaction.name}`, record)",
					"                        } else {",
					"                        results.apm.set(entry._source.transaction.name, [{ labels }])",
					"                        }",
					"                    } else {",
					"                        results.reason = 'more indexes found'",
					"                        results.fail = true",
					"                    }",
					"                })",
					"    ",
					"                pm.test(\"indexes to match only mojaloop and apm\", function () {",
					"                    pm.expect(results.fail).to.eql(false)",
					"                    pm.test(\"mojaloop index values match the expected count and values\", () => {",
					"                        pm.expect(results.mojaloop.size).to.eql(expectations.mojaloop.size)",
					"                        for (let [key, value] of results.mojaloop) {",
					"                            pm.expect(value).to.include.all.deep.members(expectations.mojaloop.get(key))",
					"                            // console.log(\"Service:\",key)",
					"                            // console.log(\"Values:\",value)",
					"                            // console.log(\"Keys:\",expectations.mojaloop.get(key))",
					"                        }",
					"                    })",
					"                    pm.test(\"apm index values match the expected count and values\", function () {",
					"                        pm.expect(results.apm.size).to.eql(expectations.apm.size)",
					"                        for (let [key, value] of results.apm) {",
					"                            pm.expect(value).to.include.all.deep.members(expectations.apm.get(key))",
					"                        }",
					"                    })",
					"                })",
					"            });",
					"        }",
					"}",
					"",
					""
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"id": "f1810c90-0862-423b-971d-0c0ee7418e4e",
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		}
	],
	"variable": [
		{
			"id": "fac5ddec-0b7d-4048-afb3-956edbea8beb",
			"key": "RUN_EFK_TESTS",
			"value": "true",
			"type": "string",
			"disabled": true
		},
		{
			"id": "3e9de964-d3f5-4196-9f25-46a214a56e14",
			"key": "TIMEOUT_EFK_TESTS",
			"value": "20000",
			"type": "string"
		}
	],
	"protocolProfileBehavior": {}
}